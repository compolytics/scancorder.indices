---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  warning = FALSE
)
```

# COMPOLYTICS® ScanCorder Vegetation Indices R Package

<!-- badges: start -->
<!-- badges: end -->

This package provides tools to process spectral data from plant samples recorded with the ScanCorder using CICADA, and to calculate a wide range of vegetation indices. 

## Installation

### From GitLab package registry

You can install the source package from [GitLab](https://gitlab.com/compolytics-public/scancorder.indices/-/packages/).

#### Windows/Linux

``` r
options(repos = c(
  gitlab = "https://gitlab.com/api/v4/projects/70774833/packages/generic/scancorder.indices/1.3.0/",
  CRAN   = "https://cloud.r-project.org"
))
install.packages("scancorder.indices")
```

### From GitHub Repository

You can install the development version of `scancorder.indices` from [GitHub](https://github.com/) with (available soon):

``` r
# install.packages("pak")
pak::pak("compolytics/scancorder.indices")
```
For private repository, valid GitHub colaborator credentials are required.

### From R Package Repository

Install from CRAN package manager (available soon):

```r
install.packages("scancorder.indices")
```

## Example

This basic example demonstrates how to calculate a table of spectral indices from a CICADA json file containing ScanCorder sensor data.

```{r example}
# include scancorder.indices package
library(scancorder.indices)

# First rule of programming: clean it
rm(list = ls())
# Step 0: What data file to process
# ------------------------------------------------------------------------------
# Please change this to the path and file name of your CICADA json data file.
# ------------------------------------------------------------------------------
# Change this name to the actual file you exported from the CICADA measurement app
# This file is also available from the Compolytics website (https://compolytics.com/vi-ppda)
cicada_file_name = "Compolytics_R-Package_VI_Test_File.json"
# Get current directory
current_dir <- getwd()
# Build full path + file name to the data file, change this location to the
# location of your actual file
sensor_file_path <- file.path(current_dir, "example", "data", cicada_file_name)

# Step 1: Load the json file and extract data
# ------------------------------------------------------------------------------
# Setup a decoder that will average the reflectance per LED across sensor channels
decoder <- DecodeCompolyticsRegularScanner$new(average_sensor_values = TRUE)
# Decode the sensor data file reflectance values
data <- decoder$score(sensor_file_path)

# Step 2: Run multi calibration for improved reflectance
# ------------------------------------------------------------------------------
# Setup multi-calibration tool
calibrator <- CalibrationReflectanceMultipoint$new()
# Run multi-calibration with sensor provided factors
calibReflectance <- calibrator$score(data$reflectance, sensor_file_path)

# Step 3: Calculate Indices table from all available data
# ------------------------------------------------------------------------------
index_table <- calculate_indices_table(data$wavelength, calibReflectance, data$fwhm, data$meta_table, data$sensor_info)

# Step 4: Save spectral indices in CSV file
# ------------------------------------------------------------------------------
# Generate an output file name based on the input file name
# ------------------------------------------------------------------------------
# Change this file and path to the location where you want to save the indices table
# ------------------------------------------------------------------------------
table_file_path <- file.path(current_dir, "example", "data", "Compolytics_R-Package_VI_Test_File_Indices.csv")
write_indices_csv(index_table, table_file_path, row.names = FALSE)

# ------------------------------------------------------------------------------
# The End
```

<div style="overflow-x:auto;">

```{r print‐my‐table, echo=FALSE}
first10 <- head(index_table, 10)
# (1) Assume `my_table` already exists
knitr::kable(
  first10,
  caption = "Spectral indices calculated from CICADA data.",
  format  = "markdown"
)
```


