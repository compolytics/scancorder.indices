---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# Compolytics (C) Scancorder Indices R-Package

<!-- badges: start -->
<!-- badges: end -->

This package provides an implementation to decode sample files recorded
using CICADA and subsequently calculate well known spectral indices. 

## Installation

### From GitLab package registry

You can install compiled platform-specific version of `scancorder.indices` from [GitLab](https://gitlab.com/compolytics-public/scancorder.indices/-/packages/). 
Currently supported platforms are: Windows, Linux and MacOS

``` r
# Define the direct URL to the package
package_url <- "https://gitlab.com/api/v4/projects/70774833/packages/generic/scancorder.indices/**<version in X.X.X format>**/**<windows|linux|macos>**/scancorder.indices**<.zip|.tar.gz|.tgz>**"

# Install the binary package
install.packages(package_url,
                 repos=NULL,
                 type = "**<win.binary|binary|mac.binary>**")
```

### From Github Repository

You can install the development version of `scancorder.indices` from [GitHub](https://github.com/) with:

``` r
# install.packages("pak")
pak::pak("compolytics/scancorder.indices")
```
For private repository, valid github colaborator credentials are required.

### From R Package Repository

Install from CRAN package manager (available soon):

```r
install.packages("scancorder.indices")
```

## Example

This is a basic example to calculate a table of spectral indices from a 
CICADA json data file holding Scancorder sensor data.

```{r example}
library(scancorder.indices)

# First rule of programming: clean it
rm(list = ls())
# Step 0: What data file to process
# ------------------------------------------------------------------------------
# Get current directory
current_dir <- getwd()
# Build file
data_file_path <- file.path(current_dir, "example", "data", "2025-02-20_11-57-59_exampleDataFiles.json")

# Step 1: Load Json file and extract data
# ------------------------------------------------------------------------------
# Load the JSON file with the sensor reading
json_input <- readChar(data_file_path, nchars = file.info(data_file_path)$size)
# Setup a decoder that will average the reflectance per LED across sensor channels
decoder <- DecodeCompolyticsRegularScanner$new(average_sensor_values = TRUE)
# Decode the JSON input to get the reflectance values
data <- decoder$score(json_input)

# Step 2: Run multi calibration for improved reflectance
# ------------------------------------------------------------------------------
# Setup multi-calibration tool
calibrator <- CalibrationReflectanceMultipoint$new()
# Run multi-calibration with sensor provided factors
calibReflectance <- calibrator$score(data$reflectance, json_input)

# Step 3: Calculate Indices table from all available data
# ------------------------------------------------------------------------------
index_table <- calculate_indices_table(data$wavelength, calibReflectance, data$fwhm, data$meta_table)
table_file_path <- file.path(current_dir, "example", "data", "2025-02-20_11-57-59_exampleDataFiles_Indices.csv")
write_indices_csv(index_table, table_file_path, row.names = FALSE)

# ------------------------------------------------------------------------------
# The End
```

<div style="overflow-x:auto;">

```{r print‐my‐table, echo=FALSE}
first10 <- head(index_table, 10)
# (1) Assume `my_table` already exists
knitr::kable(
  first10,
  caption = "Spectral indices calculated from CICADA data.",
  format  = "markdown"
)
```


